{"version":3,"file":"wtw.min.js","sources":["../src/DaemonWorker.ts","../src/utils.ts","../src/ThreadBase.ts","../src/Thread.ts","../src/index.ts"],"sourcesContent":["export class Deamon {\n\n  private objectUri: string = undefined\n\n  constructor() {\n    // init DeamonWorker\n  }\n\n  private buildScript= () => `self.onconnect = function(e) {\n    var port = e.ports[0];\n    port.onmessage = function(e) {\n      const delay = e.data[0]\n      setTimeout(() => {\n        port.postMessage('timeOver')\n        port.close()\n      }, delay)\n    }\n  }`\n\n  private buildUri = (jsScriprt: string) => {\n    const URL = window.URL || window.webkitURL\n    const blob = new Blob([jsScriprt], { type: 'application/javascript' }) // eslint-disable-line\n    this.objectUri = URL.createObjectURL(blob)\n  }\n\n  private create = () => {\n    if (!this.objectUri) {\n      this.buildUri(this.buildScript())\n    }\n  }\n\n  public getDeamonWorker = () => {\n    this.create()\n    return new SharedWorker(this.objectUri)\n  }\n}\n\nexport const DeamonWorker = new Deamon()","import { InferredType, ExtensionArrayType, CollectionFuncObj, TestArrayType, PostParams, ExecptionMessage } from \"./types\"\n\nconst isValid = (argument: any) => (types: InferredType | InferredType[]) => {\n  if (Array.isArray(types)) {\n    return types.some(type => isValidArg(argument)(type))\n  }\n  if (isValidArg(argument)(types)) {\n    return true\n  }\n  return false\n}\n\nconst isValidArg = (arg: any) => (type: InferredType) => {\n  if (type === 'null') {\n    return arg === null\n  }\n  if (type === 'undefined') {\n    return arg === undefined\n  }\n  if (type === 'action') {\n    return isValidAction(arg)\n  }\n  if (Array.isArray(arg)) {\n    if (type !== 'array' && !testArray[type as ExtensionArrayType]) return false\n    if (type === 'array') return true\n    return testArray[type as ExtensionArrayType](arg)\n  }\n  if (arg) {\n    return typeof arg === type.toString() // eslint-disable-line\n  }\n  return false\n}\n\nconst isValidAction = (obj:CollectionFuncObj) => {\n  return isValidObjectWith(['message', 'func'])(obj) &&\n    typeof obj.func === 'function' && typeof obj.message === 'string'\n}\n\n// Verify that the fields exists in the Object\nconst isValidObjectWith = (fields: string[]) => (obj:Object) =>\n  !!obj && !Array.isArray(obj) && fields.every(field => obj.hasOwnProperty(field))\n\nconst testArray:TestArrayType = {\n  'actionsArray': (arr): boolean => isValidActionsArray(arr),\n  'arraysArray': (arr) => arr.every(item => Array.isArray(item)),\n  'objectsArray': (arr) => isValidObjectsArray(arr)(),\n  'postParamsArray': (arr) => isValidPostParamsArray(arr),\n  'stringsArray': (arr) => arr.every(item => typeof item === 'string')\n}\n\nconst isValidActionsArray:(arr:CollectionFuncObj[]) => boolean = (arr) => arr.every(isValidAction)\n\nconst isValidObjectsArray = (arr:Object[]) => (fields:string[] = []) =>\n  arr.every(isValidObjectWith(fields))\n\nconst isValidPostParamsArray = (arr:any[]) => arr.every(isValidPostParams)\n\nconst isValidPostParams = (obj: PostParams) => {\n  return isValidObjectWith(['message', 'args'])(obj) &&\n    Array.isArray(obj.args) && typeof obj.message === 'string'\n}\n\n// Argument error builder\nconst argumentError = ({ expected = '', received, extraInfo = '' }:ExecptionMessage) => {\n  try {\n    return new TypeError(`${'You should provide ' + expected}${'\\n' + extraInfo}${'\\nReceived: ' + JSON.stringify(received)}`)\n  } catch (err: unknown) {\n    if ((err as DOMException).message === 'Converting circular structure to JSON') {\n      return new TypeError(`${'You should provide ' + expected}${'\\n' + extraInfo}${'\\nReceived a circular structure: ' + received}`)\n    }\n    throw err\n  }\n}\n\nexport {\n  argumentError,\n  isValid\n}","export class ThreadBase {\n    constructor() {}\n    run: <T>(task: Function, args?: any) => (delay?: number) => (Promise<T | string> | undefined)\n    = () => () => {\n      console.error('This browser does not have the conditions for execution')\n      return undefined\n    };\n}","import { ArgumentType } from \"./types\";\nimport { DeamonWorker, Deamon } from \"./DaemonWorker\";\nimport { isValid, argumentError } from \"./utils\";\nimport { ThreadBase } from \"./ThreadBase\";\n\nexport class Thread extends ThreadBase {\n  constructor(threadOptions?: { objectUri?: string, worker?: Worker, deamonWorker?: Deamon }) {\n    super()\n    this.objectUri = threadOptions?.objectUri;\n    this.worker = threadOptions?.worker;\n    this.deamonWorker = threadOptions?.deamonWorker || DeamonWorker\n  }\n\n  private deamonWorker: Deamon;\n\n  private objectUri: string;\n\n  private worker: Worker;\n\n  private buildScript = (task: Function) => `\n  self.onmessage = function(event) {\n    const args = event.data.message.args\n    if (args) {\n      self.postMessage((${task}).apply(null, args))\n      return close()\n    }\n    self.postMessage((${task})())\n    return close()\n  }`\n\n  // private buildTimingScript = (task: Function, sharedUri: string, delay: number) => `\n  // self.onmessage = function(event) {\n  //   var sharedWorker = new SharedWorker('${sharedUri}');\n  //   sharedWorker.port.onmessage = function(e) {\n  //     console.log(e, 'Message received from DaemonWorker');\n  //     self.postMessage(e.data + \\`. this worker (${task}) is close\\`)\n  //     return close()\n  //   }\n  //   sharedWorker.port.postMessage([${delay}])\n  //   const args = event.data.message.args\n  //   if (args) {\n  //     self.postMessage((${task}).apply(null, args))\n  //     return close()\n  //   }\n  //   self.postMessage((${task})())\n  //   return close()\n  // }`// woker堆栈问题, onmessage一定会在该方法执行完之后执行, 没办法取到一个监听作用\n\n  private buildUri = (jsScriprt: string) => {\n    const URL = window.URL || window.webkitURL\n    const blob = new Blob([jsScriprt], { type: 'application/javascript' }) // eslint-disable-line\n    this.objectUri = URL.createObjectURL(blob)\n  }\n\n  private create = (func: Function, delay?: number) => {\n    // objectUri is not exsit. init\n    const that = this\n    if (!that.objectUri) {\n      let jsScriprtStr = this.buildScript(func)\n      that.buildUri(jsScriprtStr)\n    }\n    // worker is not exsit. init\n    if (!that.worker) {\n      that.worker = new Worker(this.objectUri)\n    }\n  }\n\n  private createDeamonWorker: (delay?: number) => Promise<string> | undefined = (delay) => {\n    // deamonWorker is not exsit. init\n    const that = this\n    if (!!delay && delay > 0) {\n      const deammonTiming = that.deamonWorker.getDeamonWorker()\n      return new Promise<string>((resolve, reject) => {\n        deammonTiming.port.onmessage = (e) => {\n          that.destroy()\n          reject(`${e.data}. this worker is closed`)\n        }\n        deammonTiming.port.postMessage([delay])\n      })\n    }\n    return undefined\n  }\n\n\n  private destroy = () => {\n    if (this.worker) {\n      this.worker.terminate()\n      this.worker = undefined\n    }\n    if (this.objectUri !== \"testUri\") {\n      const URL = window.URL || window.webkitURL\n      URL.revokeObjectURL(this.objectUri)\n      this.objectUri = undefined\n    }\n  }\n\n  public run = <T>(task: Function, args?: ArgumentType) => {\n    const validWork = isValid(task)('function')\n    const validArgs = isValid(args)(['array', 'undefined'])\n    if (!validWork) {\n      console.error(argumentError({ expected: 'a function', received: task }))\n      return null\n    }\n    if (!validArgs) {\n      console.error(argumentError({ expected: 'an array', received: args }))\n      return null\n    }\n\n    const that = this\n    this.create(task)\n    return (delay?: number) => {\n      const deamonPromise = this.createDeamonWorker(delay);\n      return new Promise<T | string>((resolve, reject) => {\n        !!deamonPromise && deamonPromise.catch(reject)\n        that.worker.onmessage = (event) => {\n          that.destroy()\n          resolve(event.data)\n        }\n        that.worker.onerror = (error: ErrorEvent) => {\n          console.error(`Error: Line ${error.lineno} in ${error.filename}: ${error.message}`)\n          reject(error)\n        }\n        that.worker.postMessage({ message: { args } })\n      })\n    }\n  }\n}","import { Thread } from \"./Thread\"\nimport { ThreadBase } from \"./ThreadBase\"\nimport { ThreadConstructor } from \"./types\"\nclass WorkerBuilder {\n  private thread: ThreadConstructor;\n  \n  constructor() {\n    this.thread = ThreadBase\n    if (!window.Worker) {\n      console.error('This browser does not support Workers.')\n      return\n    }\n    if (!window.SharedWorker) {\n      console.error('This browser does not support SharedWorker.')\n      return\n    }\n    if (!(window.URL.createObjectURL || window.webkitURL.createObjectURL)) {\n      console.error('This browser does not have URL.createObjectURL method.')\n      return\n    }\n    this.thread = Thread\n  }\n  public build = () => this.thread\n}\n\nexport default WorkerBuilder\n\n\n// const WorkerBuilder = () => {\n//   let thread: any = class{\n//     constructor(){}\n//     public run = () => {console.error('This browser does not have the conditions for execution')}\n//   }\n  \n//   if (!window.Worker) {\n//     console.error('This browser does not support Workers.')\n//   }else if (!window.SharedWorker) {\n//     console.error('This browser does not support SharedWorker.')\n//   }else if (!(window.URL.createObjectURL || window.webkitURL.createObjectURL)) {\n//     console.error('This browser does not have URL.createObjectURL method.')\n//   }else{\n//     thread = Thread\n//   }\n//   return thread\n// }\n\n// const Test = WorkerBuilder()\n\n// export default WorkerBuilder"],"names":["Deamon","objectUri","undefined","constructor","buildScript","buildUri","URL","window","webkitURL","blob","Blob","jsScriprt","type","this","createObjectURL","create","getDeamonWorker","SharedWorker","DeamonWorker","isValid","Array","isArray","types","some","isValidArg","argument","arg","isValidAction","testArray","toString","isValidObjectWith","obj","func","message","fields","every","field","hasOwnProperty","actionsArray","isValidActionsArray","arr","arraysArray","item","objectsArray","isValidObjectsArray","postParamsArray","isValidPostParamsArray","stringsArray","isValidPostParams","args","argumentError","expected","received","extraInfo","TypeError","JSON","stringify","err","ThreadBase","run","console","error","Thread","threadOptions","super","worker","deamonWorker","task","delay","that","jsScriprtStr","Worker","createDeamonWorker","deammonTiming","Promise","resolve","reject","port","onmessage","destroy","e","data","postMessage","terminate","revokeObjectURL","validWork","validArgs","deamonPromise","catch","event","onerror","lineno","filename","WorkerBuilder","thread","build"],"mappings":"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"}